const title = titleInput.value;
                const genre = genreInput.value;

                const searchQuery = `${title} ${genre} (${type})`;
                const encodedSearchQuery = encodeURIComponent(searchQuery);
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = `https://www.youtube.com/results?search_query=${encodedSearchQuery}`;
                const url = proxyUrl + targetUrl;

                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 429) {
                        retryCount++;
                        if (retryCount <= maxRetries) {
                            console.log(`Rate limit exceeded. Retrying after delay... (${retryCount}/${maxRetries})`);
                            document.getElementById('error-message').innerText = `Rate limit exceeded. Retrying after delay... (${retryCount}/${maxRetries})`;
                            setTimeout(searchSong, retryDelay);
                            return;
                        } else {
                            throw new Error(`Rate limit exceeded. Maximum retries reached (${maxRetries}).`);
                        }
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }
                const text = await response.text();
                const videoIdMatches = text.match(/"videoId":"(.*?)"/g) || [];
                const titleMatches = text.match(/"title":{"runs":\[{"text":"(.*?)"}/g) || [];

                if (videoIdMatches.length > 0) {
                    let videoId, videoTitle;
                    if (searchType === "Top Result") {
                        videoId = videoIdMatches[0].match(/"videoId":"(.*?)"/)[1];
                        videoTitle = titleMatches[0].match(/"title":{"runs":\[{"text":"(.*?)"}/)[1];
                    } else {
                        const randomIndex = Math.floor(Math.random() * videoIdMatches.length);
                        videoId = videoIdMatches[randomIndex].match(/"videoId":"(.*?)"/)[1];
                        const videoLink = `https://www.youtube.com/watch?v=${videoId}`;
                        const videoCheckUrl = `https://www.youtube.com/oembed?url=${videoLink}&format=json`;
                        const videoCheckResponse = await fetch(videoCheckUrl);

                        if (videoCheckResponse.ok) {
                            const videoData = await videoCheckResponse.json();
                            videoTitle = videoData.title;
                        } else {
                            videoTitle = `Random Video ${randomIndex + 1}`;
                        }
                    }

                    const videoLink = `https://www.youtube.com/watch?v=${videoId}`;
                    const videoCheckUrl = `https://www.youtube.com/oembed?url=${videoLink}&format=json`;
                    const videoCheckResponse = await fetch(videoCheckUrl);

                    if (videoCheckResponse.ok) {
                        const linkCode = `<div><a href="${videoLink}" target="_blank">${videoTitle}</a></div>`;
                        document.getElementById('result').innerHTML = linkCode;

                        // Extract artist and song title for lyrics fetching
                        let artist = "";
                        let songTitle = videoTitle;
                        if (videoTitle.includes(" - ")) {
                            const parts = videoTitle.split(" - ");
                            if (parts.length === 2) {
                                artist = parts[0].trim();
                                songTitle = parts[1].trim();
                            }
                        }

                        if (artist && songTitle) {
                            const lyrics = await fetchLyrics(artist, songTitle);
                            document.getElementById('lyrics').innerHTML = lyrics;
                        } else {
                            document.getElementById('lyrics').innerHTML = "Unable to fetch lyrics for this video.";
                        }

                        console.log('Retrieved Video:', videoTitle);
                    } else {
                        document.getElementById('result').innerHTML = "Video unavailable.";
                    }
                } else {
                    document.getElementById('result').innerHTML = "No video found.";
                }
            } catch (error) {
                console.error('An error occurred while searching for the song:', error);
                document.getElementById('error-message').innerText = `An error occurred while searching for the song: ${error.message}`;
            }
        }
    </script>
</body>
</html>
