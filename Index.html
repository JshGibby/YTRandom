<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Music Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>YouTube Music Search</h1>
    <button onclick="openCORS()">CORS Enabling System</button>
    <label>
        <input type="checkbox" id="randomTitle" onchange="toggleInput('title', 'randomTitle')"> Use random title
    </label>
    <input type="text" id="title" placeholder="Enter song title">
    <label>
        <input type="checkbox" id="randomGenre" onchange="toggleInput('genre', 'randomGenre')"> Use random genre
    </label>
    <input type="text" id="genre" placeholder="Enter genre">
    <label>
        <input type="checkbox" id="loopRandom"> Loop Random
    </label>
    <div>
        <label>
            <input type="radio" name="type" value="Official Audio" checked> Official Audio
        </label>
        <label>
            <input type="radio" name="type" value="Music Video"> Music Video
        </label>
    </div>
    <button onclick="searchSong()">Search</button>
    <div id="result"></div>
    <div id="lyrics"></div>

    <script>
        function openCORS() {
            window.open('https://cors-anywhere.herokuapp.com/corsdemo', '_blank');
        }

        function toggleInput(inputId, checkboxId) {
            const input = document.getElementById(inputId);
            const checkbox = document.getElementById(checkboxId);
            input.disabled = checkbox.checked;
        }

        async function fetchTextFile(url) {
            const response = await fetch(url);
            const text = await response.text();
            return text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        }

        async function getRandomWord() {
            const words = await fetchTextFile('words.txt');
            return words[Math.floor(Math.random() * words.length)];
        }

        async function getRandomGenre() {
            const genres = await fetchTextFile('genres.txt');
            return genres[Math.floor(Math.random() * genres.length)];
        }

        async function searchSong() {
            try {
                const titleInput = document.getElementById('title');
                const genreInput = document.getElementById('genre');
                const useRandomTitle = document.getElementById('randomTitle').checked;
                const useRandomGenre = document.getElementById('randomGenre').checked;
                const type = document.querySelector('input[name="type"]:checked').value;

                const title = useRandomTitle ? await getRandomWord() : titleInput.value;
                if (useRandomTitle) titleInput.value = title;

                const genre = useRandomGenre ? await getRandomGenre() : genreInput.value;
                if (useRandomGenre) genreInput.value = genre;

                const searchQuery = `${title} ${genre} (${type})`;
                const encodedSearchQuery = encodeURIComponent(searchQuery);
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = `https://www.youtube.com/results?search_query=${encodedSearchQuery}`;
                const url = proxyUrl + targetUrl;
                
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 429) {
                        console.warn('Rate limit exceeded. Retrying after delay...');
                        setTimeout(searchSong, 5000); // Retry after 5 seconds
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                const videoIdMatch = text.match(/"videoId":"(.*?)"/);
                const titleMatch = text.match(/"title":{"runs":

\[{"text":"(.*?)"}/);
                if (videoIdMatch && titleMatch) {
                    const videoId = videoIdMatch[1];
                    const videoTitle = titleMatch[1];
                    const linkCode = `<div><strong>${videoTitle}</strong></div><a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">${title} ${genre} (${type})</a>`;
                    document.getElementById('result').innerHTML = linkCode;

                    // Fetch lyrics using the retrieved title
                    const lyricsResponse = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(videoTitle)}/${encodeURIComponent(genre)}`);
                    const lyricsData = await lyricsResponse.json();
                    if (lyricsData.lyrics) {
                        document.getElementById('lyrics').innerHTML = `<pre>${lyricsData.lyrics}</pre>`;
                    } else {
                        document.getElementById('lyrics').innerHTML = "No lyrics found.";
                    }
                } else {
                    document.getElementById('result').innerHTML = "No video found.";
                    if (document.getElementById('loopRandom').checked) {
                        setTimeout(searchSong, 1000);
                    }
                }
            } catch (error) {
                console.error('An error occurred while searching for the song:', error);
                document.getElementById('result').innerHTML = "An error occurred while searching for the song.";
            }
        }
    </script>
</body>
</html>
